name: Filetype Check (FORBIDDEN patterns only)
description: Fails if committed files match FORBIDDEN patterns from central-gitignore.txt

inputs:
  rules-url:
    description: "URL to central-gitignore.txt"
    required: false
    default: "https://raw.githubusercontent.com/AmsterdamUMC-test/org-security-workflows/main/central-gitignore.txt"

runs:
  using: "composite"
  steps:
    - name: Download central gitignore
      shell: bash
      run: |
        curl -sL "${{ inputs.rules-url }}" -o central-gitignore.txt

    - name: Extract FORBIDDEN patterns
      shell: bash
      run: |
        # Extract blocked and exception patterns separately
        awk '
          /^# BEGIN FORBIDDEN/ { capture=1; next }
          /^# END FORBIDDEN/   { capture=0; next }
          capture && /^[^#]/ && NF { print }
        ' central-gitignore.txt > forbidden-patterns.txt

        echo "Extracted forbidden patterns:"
        cat forbidden-patterns.txt

    - name: Check all tracked files
      shell: bash
      run: |
        if [[ ! -s forbidden-patterns.txt ]]; then
          echo "No FORBIDDEN patterns found, skipping check"
          exit 0
        fi

        # Parse patterns into blocked and exceptions
        BLOCKED_PATTERNS=()
        EXCEPTION_PATTERNS=()

        while IFS= read -r line; do
          [[ -z "$line" ]] && continue
          if [[ "$line" == !* ]]; then
            EXCEPTION_PATTERNS+=("${line#!}")
          else
            BLOCKED_PATTERNS+=("${line}")
          fi
        done < forbidden-patterns.txt

        # Function to check if filename matches a glob pattern
        matches_pattern() {
          local file="$1"
          local pattern="$2"
          local basename="${file##*/}"

          if [[ "$pattern" == \** ]]; then
            [[ "$basename" == $pattern ]] && return 0
          elif [[ "$pattern" == .* ]]; then
            [[ "$basename" == $pattern ]] && return 0
          elif [[ "$basename" == "$pattern" ]]; then
            return 0
          fi
          return 1
        }

        BLOCKED=0
        BLOCKED_FILES=()

        while IFS= read -r FILE; do
          is_blocked=false
          is_exception=false

          # Check if file matches any blocked pattern
          for pattern in "${BLOCKED_PATTERNS[@]}"; do
            if matches_pattern "$FILE" "$pattern"; then
              is_blocked=true
              break
            fi
          done

          # If blocked, check if it's an exception
          if [[ "$is_blocked" == true ]]; then
            for pattern in "${EXCEPTION_PATTERNS[@]}"; do
              if matches_pattern "$FILE" "$pattern"; then
                is_exception=true
                break
              fi
            done
          fi

          # Add to blocked list if blocked and not an exception
          if [[ "$is_blocked" == true && "$is_exception" == false ]]; then
            echo "::error file=$FILE::Blocked by FORBIDDEN patterns in central-gitignore.txt"
            BLOCKED_FILES+=("$FILE")
            BLOCKED=1
          fi
        done < <(git ls-files)

        if [[ $BLOCKED -eq 1 ]]; then
          echo ""
          echo "=========================================="
          echo "ERROR: Forbidden file types detected!"
          echo "=========================================="
          echo "Blocked files:"
          for f in "${BLOCKED_FILES[@]}"; do
            echo "  - $f"
          done
          echo ""
          echo "These files must be removed from the repository."
          echo "See: https://github.com/AmsterdamUMC-test/org-security-workflows#remediation"
        fi

        exit $BLOCKED
